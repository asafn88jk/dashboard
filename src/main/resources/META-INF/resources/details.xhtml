<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Run Details</title>

    <f:metadata>
        <f:viewParam name="filter" value="#{runDetailsView.filter}" />
        <f:viewParam name="item" value="#{runDetailsView.item}" />
        <f:viewParam name="run" value="#{runDetailsView.run}" />
        <f:event type="preRenderView" listener="#{runDetailsView.preRender}" />
    </f:metadata>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer"></link>
    <link href="https://cdn.jsdelivr.net/gh/extent-framework/extent-github-cdn@d6562a79075e061305ccfdb82f01e5e195e2d307/spark/css/spark-style.css" rel="stylesheet"></link>

    <!-- If you serve FontAwesome locally/webjars, keep your include here.
         Otherwise, remove or keep your existing include setup. -->

    <style>
        :root {
            --bg: #f5f7fb;
            --card: #ffffff;
            --border: #e6eaf2;
            --muted: #667085;
            --shadow: 0 1px 2px rgba(16, 24, 40, 0.06);
        }
        /* -------- Extent-like typography -------- */
        html, body, .ui-widget {
            font-family: "Open Sans","Source Sans Pro","Segoe UI",Roboto,Arial,sans-serif !important;
            font-size: 13px;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #1f2937;
        }
        body.lb-open {
            overflow: hidden;
        }

        .page {
            padding: 8px 10px;
            direction: rtl;
            max-width: 100%;
            margin: 0 auto;
        }

        .topCard {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px 16px;
            box-shadow: var(--shadow);
        }

        .topRow {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .title {
            font-weight: 900;
            font-size: 16px;
            line-height: 1.2;
        }

        .meta {
            color: var(--muted);
            font-size: 11px;
            margin-top: 6px;
        }
        .runSwitcher {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            font-size: 11px;
        }
        .runSwitcherLabel { font-weight: 700; color: #475569; }
        .runChip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #1f2937;
            text-decoration: none;
            font-weight: 700;
            white-space: nowrap;
        }
        .runChip.is-active {
            background: #e2e8f0;
            border-color: #94a3b8;
        }

        .errorBox {
            margin: 10px 0;
            padding: 10px 12px;
            border-radius: 12px;
            background: #fff2f2;
            border: 1px solid #ffd1d1;
            color: #a40000;
            font-weight: 700;
        }

        /* -------- Main layout: content left, tree right -------- */
        .grid {
            margin-top: 12px;
            display: grid;
            grid-template-columns: minmax(0, 1fr) 430px;
            gap: 10px;
            direction: ltr; /* layout direction */
            align-items: stretch;
        }

        .pane {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 10px 12px;
            min-height: calc(100vh - 140px);
            direction: rtl; /* text direction */
            box-shadow: var(--shadow);
        }

        .paneHeader {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eef2f7;
            direction: rtl;
            text-align: right;
        }
        .paneBadges {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .paneTitle {
            font-weight: 900;
            font-size: 14px;
            text-align: right;
        }
        .featureHeader {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
        }
        .featureTitleRow {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .featureTitleGroup {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            flex: 1 1 auto;
        }
        .featureMetaBadges {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            flex: 0 0 auto;
        }
        .metaBadge {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #475569;
        }
        .historyBadge {
            padding: 2px 6px;
            font-weight: 800;
            min-width: 22px;
            justify-content: center;
        }

        /* -------- Pills / statuses -------- */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .st-pass { background: #d4edda; border-color: #28a745; color: #1f7a3a; }
        .st-fail { background: #f8d7da; border-color: #dc3545; color: #a11b28; }
        .st-skip { background: #e2e3e5; border-color: #cfd2d6; color: #525960; }
        .st-knownbug { background: #fff3cd; border-color: #ffc107; color: #9a6b00; }
        .st-info { background: #dbeafe; border-color: #60a5fa; color: #1d4ed8; }
        .st-unknown { background: #f3f4f6; border-color: #d1d5db; color: #4b5563; }
        .st-flaky { background: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; }

        /* -------- Tree styling -------- */
        .treeWrap { direction: rtl; }

        /* Keep PF RTL indentation stable */
        .featTree.ui-tree {
            width: 100%;
            direction: rtl;
            text-align: right;
            border: 0;
        }

        .treeRow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
            width: 100%;
            padding: 1px 2px;
            line-height: 1.2;
        }

        .treeLabel {
            font-weight: 800;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .treeGroup { font-weight: 900; color: #2f343a; }
        .treeGroupBtn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .treeGroupBtn .folderIcon {
            color: #f59e0b;
            font-size: 13px;
            margin-left: 6px;
        }
        .treeGroupBtn .folder-open { display: none; }
        .treeRow.is-open .folder-open { display: inline-block; }
        .treeRow.is-open .folder-closed { display: none; }

        .featTree .ui-treenode,
        .featTree .ui-treenode-content {
            margin: 0;
            padding: 0;
        }
        .featTree .ui-tree-container {
            margin: 0;
            padding: 0;
        }
        .featTree .ui-treenode-children {
            margin: 0;
            padding: 0 4px 0 0;
        }
        .featTree ul,
        .featTree li.ui-treenode {
            margin: 0;
            padding: 0;
        }
        .featTree .ui-treenode-toggler,
        .featTree .ui-tree-toggler,
        .featTree .ui-tree-toggler-icon {
            display: none !important;
        }
        .featTree li.hidden-by-filter { display: none !important; }
        .treeRow[data-node-type="group"] { pointer-events: none; }
        .treeRow[data-node-type="group"] .js-tree-toggle { pointer-events: auto; }

        .treeCounts {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            font-size: 11px;
        }

        .treeCountBadge {
            padding: 1px 6px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 800;
            min-width: 22px;
            justify-content: center;
        }

        .treeFilters {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 10px;
        }
        .treeFiltersRow {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            align-items: center;
            justify-content: flex-start;
        }
        .statusFilters {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            flex: 0 0 auto;
        }
        .filterBtn {
            border: 1px solid #e5e7eb;
            background: #fff;
            border-radius: 8px;
            padding: 4px 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .filterBtn.icon-only {
            min-width: 30px;
            justify-content: center;
            padding: 4px 6px;
        }
        .filterBtn.is-active {
            box-shadow: inset 0 0 0 1px #94a3b8;
            background: #eef2ff;
        }
        .filterBtn.filter-pass { color: #1f7a3a; }
        .filterBtn.filter-fail { color: #a11b28; }
        .filterBtn.filter-knownbug { color: #9a6b00; }
        .filterBtn.filter-skip { color: #4b5563; }

        .tagFilter select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
            background: #fff;
            min-width: 120px;
        }
        .treeControls {
            display: flex;
            gap: 6px;
            flex: 0 0 auto;
        }
        .treeControlBtn {
            border: 1px solid #e5e7eb;
            background: #fff;
            border-radius: 8px;
            padding: 4px 6px;
            cursor: pointer;
        }

        /* -------- Panels as accordions, no toggle icon -------- */
        .ui-panel .ui-panel-titlebar-icon,
        .ui-panel .ui-panel-titlebar-toggler,
        .ui-panel .ui-panel-titlebar .ui-panel-titlebar-icon,
        .ui-panel .ui-panel-titlebar .ui-icon {
            display: none !important; /* remove +/-/triangle */
        }
        .ui-panel .ui-panel-titlebar {
            cursor: pointer;
            border-radius: 12px;
            background: #fff;
            border: 0;
            padding: 10px 12px;
        }
        .ui-panel .ui-panel-content {
            border: 0;
            padding: 10px 12px 12px;
        }

        .scenarioPanel.ui-panel {
            margin-bottom: 10px;
            border: 1px solid #edf0f5;
            box-shadow: 0 1px 1px rgba(16, 24, 40, 0.04);
        }
        .stepPanel.ui-panel {
            margin: 8px 0;
            border: 1px solid #edf0f5;
            background: #fbfcfe;
        }

        .hdrLine {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            width: 100%;
            direction: rtl;
        }

        .hdrText {
            font-weight: 900;
            white-space: normal;
            line-height: 1.3;
        }

        .scenarioHdr {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            font-weight: 800;
            direction: rtl;
            text-align: right;
            flex: 1 1 auto;
            justify-content: flex-start;
        }
        .historyRow {
            display: inline-flex;
            gap: 4px;
            align-items: center;
            flex: 0 0 auto;
        }
        .historyDot {
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 800;
            border: 1px solid rgba(15, 23, 42, 0.12);
        }

        .scenarioTitle {
            min-width: 0;
            flex: 1 1 auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            direction: rtl;
            text-align: right;
            unicode-bidi: plaintext;
        }

        .stepHdr {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            font-weight: 800;
            direction: rtl;
            text-align: right;
            flex: 1 1 auto;
            justify-content: flex-start;
        }
        .stepTitle {
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            direction: rtl;
            text-align: right;
            unicode-bidi: plaintext;
        }
        .stepKeyword { font-weight: 900; }

        .statusIcon { font-size: 14px; }
        .ico-pass { color: #1f7a3a; }
        .ico-fail { color: #a11b28; }
        .ico-knownbug { color: #9a6b00; }
        .ico-skip { color: #4b5563; }
        .ico-info { color: #1d4ed8; }
        .ico-unknown { color: #6b7280; }

        .subMeta {
            font-size: 11px;
            color: var(--muted);
        }
        .hdrLine > .subMeta {
            direction: ltr;
            text-align: left;
        }
        .scenarioMeta {
            font-variant-numeric: tabular-nums;
        }

        .tags {
            display: inline-flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #f5f6f8;
            border: 1px solid #e5e7eb;
            color: #333;
        }

        /* -------- Extent log HTML normalization -------- */
        /* Hide Extent timestamp/localtime paragraphs embedded in detailsHtml */
        .contentPane p.timestamp,
        .contentPane p.localtime,
        .contentPane .timestamp,
        .contentPane .localtime {
            display: none !important;
        }

        /* Make Extent step tables “invisible” (no borders, no boxy look) */
        .contentPane table.markup-table {
            border: 0 !important;
            border-collapse: collapse !important;
            width: auto;
        }
        .contentPane table.markup-table td,
        .contentPane table.markup-table th {
            border: 0 !important;
            padding: 2px 6px 2px 0 !important;
            vertical-align: top;
        }

        /* Each log row wrapper: no border, minimal spacing */
        .logRow {
            padding: 6px 0;
            margin: 0;
            display: grid;
            grid-template-columns: 52px minmax(0, 1fr);
            gap: 8px;
            direction: ltr;
        }
        .logRow + .logRow {
            border-top: 1px dashed #eef2f7;
        }
        .logTime {
            font-size: 11px;
            color: #6b7280;
            font-variant-numeric: tabular-nums;
            padding-top: 2px;
            text-align: right;
        }
        .logBody {
            min-width: 0;
            direction: rtl;
            text-align: right;
        }
        .logBody * {
            text-align: right;
        }
        .logBody table,
        .logBody th,
        .logBody td {
            text-align: right;
        }

        .mediaImg {
            margin-top: 8px;
            max-width: 240px;
            max-height: 140px;
            width: auto;
            height: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            cursor: zoom-in;
        }
        .mediaLink {
            display: inline-block;
        }

        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 24px;
        }
        .lightbox.is-open { display: flex; }
        .lightbox-content {
            position: relative;
            max-width: min(92vw, 1200px);
            max-height: 88vh;
        }
        .lightbox-img {
            display: block;
            max-width: 100%;
            max-height: 88vh;
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
            background: #fff;
        }
        .lightbox-close {
            position: absolute;
            top: -14px;
            left: -14px;
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #111827;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .emptyHint {
            color: #666;
            font-size: 13px;
            padding: 10px 0;
        }

        @media (max-width: 1100px) {
            .grid { grid-template-columns: 1fr; }
            .pane { min-height: auto; }
        }
    </style>
</h:head>

<h:body>
    <div class="page">

        <h:panelGroup id="titleBar" layout="block" styleClass="topCard">
            <div class="topRow">
                <div>
                    <div class="title">
                        #{runDetailsView.filter} • #{runDetailsView.item} • #{runDetailsView.run}
                    </div>
                    <div class="meta">
                        משך: #{runDetailsView.runDurationText()}
                        <span style="margin:0 8px;">|</span>
                        DIR: #{runDetailsView.runDir}
                    </div>
                    <ui:fragment rendered="#{runDetailsView.hasHistory}">
                        <div class="runSwitcher">
                            <span class="runSwitcherLabel">Runs:</span>
                            <ui:repeat value="#{runDetailsView.recentRuns}" var="r">
                                <h:link outcome="details"
                                        styleClass="runChip #{r.current ? 'is-active' : ''}"
                                        title="#{r.tooltip}">
                                    <f:param name="filter" value="#{runDetailsView.filter}" />
                                    <f:param name="item" value="#{runDetailsView.item}" />
                                    <f:param name="run" value="#{r.runFolder}" />
                                    <h:outputText value="#{r.label}" />
                                </h:link>
                            </ui:repeat>
                        </div>
                    </ui:fragment>
                </div>

                <div class="meta" style="text-align:left;">
                    <ui:fragment rendered="#{not empty runDetailsView.summary}">
                        סה״כ: #{runDetailsView.summary.totals.total}
                        | עבר: #{runDetailsView.summary.totals.pass}
                        | נכשל: #{runDetailsView.summary.totals.fail}
                        | באג ידוע: #{runDetailsView.summary.totals.knownBug}
                        | דולג: #{runDetailsView.summary.totals.skip}
                    </ui:fragment>
                </div>
            </div>

            <ui:fragment rendered="#{not empty runDetailsView.error}">
                <div class="errorBox">
                    ERROR: #{runDetailsView.error}
                </div>
            </ui:fragment>
        </h:panelGroup>

        <h:form id="form" prependId="false">

            <div class="grid">

                <!-- LEFT: content pane -->
                <h:panelGroup id="contentPane" layout="block" styleClass="pane contentPane">

                    <ui:fragment rendered="#{empty runDetailsView.selectedFeature}">
                        <div class="paneHeader">
                            <div class="paneTitle">פירוט</div>
                            <span class="pill st-unknown">בחר Feature בעץ</span>
                        </div>
                        <div class="emptyHint">בחר Feature בעץ (מימין) כדי לראות תרחישים/צעדים/לוגים.</div>
                    </ui:fragment>

                    <ui:fragment rendered="#{not empty runDetailsView.selectedFeature}">

                        <div class="paneHeader">
                            <div class="featureHeader">
                                <div class="featureTitleRow">
                                    <div class="featureTitleGroup">
                                        <span class="pill #{runDetailsView.statusCss(runDetailsView.selectedFeature.status)}">
                                            #{runDetailsView.statusBadgeLabel(runDetailsView.selectedFeature.status)}
                                        </span>
                                        <div class="paneTitle">#{runDetailsView.selectedFeatureFullTitle}</div>
                                        <ui:fragment rendered="#{not empty runDetailsView.selectedFeature.tags}">
                                            <div class="tags inline">
                                                <ui:repeat value="#{runDetailsView.selectedFeature.tags}" var="tg">
                                                    <span class="tag">#{tg}</span>
                                                </ui:repeat>
                                            </div>
                                        </ui:fragment>
                                    </div>
                                    <div class="featureMetaBadges">
                                        <span class="pill metaBadge">
                                            Scenarios: #{runDetailsView.selectedFeature.scenarios.size()}
                                        </span>
                                        <span class="pill metaBadge">
                                            משך: #{runDetailsView.selectedFeature.durationText}
                                        </span>
                                        <ui:fragment rendered="#{not empty runDetailsView.featureHistory(runDetailsView.selectedFeature)}">
                                            <ui:repeat value="#{runDetailsView.featureHistory(runDetailsView.selectedFeature)}" var="fh">
                                                <span class="pill historyBadge #{runDetailsView.statusCss(fh.status)}"
                                                      title="#{runDetailsView.runLabel(fh.runFolder)}">
                                                    #{runDetailsView.statusShortLabel(fh.status)}
                                                </span>
                                            </ui:repeat>
                                        </ui:fragment>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scenarios accordion -->
                        <ui:repeat value="#{runDetailsView.selectedFeature.scenarios}" var="sc">

                            <p:panel toggleable="true" toggleableHeader="true"
                                     collapsed="true" styleClass="scenarioPanel">

                                <f:facet name="header">
                                    <div class="hdrLine">
                                        <div class="scenarioHdr">
                                            <span class="pill #{runDetailsView.statusCss(sc.status)}">
                                            #{runDetailsView.statusBadgeLabel(sc.status)}
                                        </span>
                                            <span class="scenarioTitle">#{sc.name}</span>
                                            <ui:fragment rendered="#{not empty runDetailsView.scenarioHistory(sc)}">
                                                <span class="historyRow">
                                                    <ui:repeat value="#{runDetailsView.scenarioHistory(sc)}" var="hs">
                                                        <span class="historyDot #{runDetailsView.statusCss(hs.status)}"
                                                              title="#{runDetailsView.runLabel(hs.runFolder)}">
                                                            #{runDetailsView.statusShortLabel(hs.status)}
                                                        </span>
                                                    </ui:repeat>
                                                </span>
                                            </ui:fragment>
                                        </div>
                                        <span class="subMeta scenarioMeta">
                                            <ui:fragment rendered="#{not empty sc.startTimeText}">
                                                #{sc.startTimeText}
                                                <span style="margin:0 6px;">|</span>
                                            </ui:fragment>
                                            #{sc.durationText}
                                        </span>
                                    </div>
                                </f:facet>

                                <!-- Steps inside scenario -->
                                <ui:repeat value="#{sc.steps}" var="st">

                                    <p:panel toggleable="true" toggleableHeader="true"
                                             collapsed="true" styleClass="stepPanel">

                                        <f:facet name="header">
                                            <div class="hdrLine">
                                        <div class="stepHdr">
                                            <i class="statusIcon #{runDetailsView.statusIconClass(st.status)} #{runDetailsView.statusIconTone(st.status)}"></i>
                                            <span class="stepTitle">
                                                <strong class="stepKeyword">#{st.keyword}</strong>
                                                <span>: </span>
                                                <span>#{st.text}</span>
                                            </span>
                                        </div>
                                        <span class="subMeta">#{st.durationText}</span>
                                    </div>
                                </f:facet>

                                        <!-- Log prints: render Extent HTML as-is (no extra borders/timestamps/badges) -->
                                        <ui:repeat value="#{st.logs}" var="lg">
                                            <ui:fragment rendered="#{not empty lg.detailsHtml or not empty lg.mediaPath}">
                                                <div class="logRow">
                                                    <span class="logTime">
                                                        <h:outputText value="#{lg.durationText}" />
                                                    </span>
                                                    <div class="logBody">
                                                        <ui:fragment rendered="#{not empty lg.detailsHtml}">
                                                            <h:outputText value="#{lg.detailsHtml}" escape="false"/>
                                                        </ui:fragment>

                                                        <ui:fragment rendered="#{not empty lg.mediaPath}">
                                                            <a href="#{runDetailsView.assetUrl(lg.mediaPath)}"
                                                               class="mediaLink js-lightbox">
                                                                <h:graphicImage value="#{runDetailsView.assetUrl(lg.mediaPath)}"
                                                                                styleClass="mediaImg"/>
                                                            </a>
                                                        </ui:fragment>
                                                    </div>
                                                </div>
                                            </ui:fragment>
                                        </ui:repeat>

                                    </p:panel>

                                </ui:repeat>

                            </p:panel>

                        </ui:repeat>

                    </ui:fragment>

                </h:panelGroup>

                <!-- RIGHT: tree pane -->
                <div class="pane treeWrap">

                    <div class="paneHeader">
                        <div class="paneTitle">עץ תוצאות</div>
                        <span class="subMeta">Features: #{runDetailsView.features.size()}</span>
                    </div>

                    <div class="treeFilters">
                        <div class="treeFiltersRow">
                            <div class="statusFilters">
                                <button type="button" class="filterBtn js-tree-status is-active" data-status="all">
                                    <i class="fa-solid fa-list"></i>All
                                </button>
                                <button type="button" class="filterBtn filter-pass js-tree-status icon-only" data-status="PASS"
                                        title="Pass">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                                <button type="button" class="filterBtn filter-fail js-tree-status icon-only" data-status="FAIL"
                                        title="Fail">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                                <button type="button" class="filterBtn filter-knownbug js-tree-status icon-only" data-status="WARNING"
                                        title="Known Bug">
                                    <i class="fa-solid fa-triangle-exclamation"></i>
                                </button>
                                <button type="button" class="filterBtn filter-skip js-tree-status icon-only" data-status="SKIP"
                                        title="Skip">
                                    <i class="fa-solid fa-forward"></i>
                                </button>
                            </div>

                            <div class="tagFilter">
                                <select id="treeTagFilter">
                                    <option value="">כל התגיות</option>
                                    <ui:repeat value="#{runDetailsView.allTags}" var="tg">
                                        <option value="#{tg}">#{tg}</option>
                                    </ui:repeat>
                                </select>
                            </div>

                            <div class="treeControls">
                                <button type="button" id="treeExpandAll" class="treeControlBtn" title="Expand all">
                                    <i class="fa-solid fa-square-plus"></i>
                                </button>
                                <button type="button" id="treeCollapseAll" class="treeControlBtn" title="Collapse all">
                                    <i class="fa-solid fa-square-minus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <p:tree id="featTree"
                            value="#{runDetailsView.featureTreeRoot}"
                            var="t"
                            selectionMode="single"
                            selection="#{runDetailsView.selectedTreeNode}"
                            styleClass="featTree ui-tree-rtl">

                        <p:ajax event="select"
                                listener="#{runDetailsView.onTreeSelect}"
                                process="@this"
                                update="contentPane :titleBar"/>

                        <p:treeNode type="GROUP">
                            <div class="treeRow" data-node-type="group">
                            <span class="treeGroup treeGroupBtn js-tree-toggle" role="button" tabindex="0">
                                <i class="fa-solid fa-folder folderIcon folder-closed"></i>
                                <i class="fa-solid fa-folder-open folderIcon folder-open"></i>
                                <span>#{t.label}</span>
                            </span>
                                <span class="treeCounts">
                                <ui:fragment rendered="#{t.passCount gt 0}">
                                    <span class="pill st-pass treeCountBadge">#{t.passCount}</span>
                                </ui:fragment>
                                <ui:fragment rendered="#{t.failCount gt 0}">
                                    <span class="pill st-fail treeCountBadge">#{t.failCount}</span>
                                </ui:fragment>
                                <ui:fragment rendered="#{t.knownBugCount gt 0}">
                                    <span class="pill st-knownbug treeCountBadge">#{t.knownBugCount}</span>
                                </ui:fragment>
                                <ui:fragment rendered="#{t.skipCount gt 0}">
                                    <span class="pill st-skip treeCountBadge">#{t.skipCount}</span>
                                </ui:fragment>
                            </span>
                            </div>
                        </p:treeNode>

                        <p:treeNode type="FEATURE">
                            <div class="treeRow"
                                 data-node-type="feature"
                                 data-status="#{t.status}"
                                 data-tags="#{runDetailsView.joinTags(t.tags)}">
                            <span class="treeLabel">
                                <span class="pill #{runDetailsView.statusCss(t.status)}">
                                #{runDetailsView.statusBadgeLabel(t.status)}
                            </span>
                                #{t.label}
                            </span>
                            </div>
                        </p:treeNode>

                        <!-- Fallback template: prevents blank tree if a node type mismatches -->
                        <p:treeNode>
                            <span>#{t.label}</span>
                        </p:treeNode>

                    </p:tree>

                </div>

            </div>

        </h:form>

    </div>

    <div id="lightbox" class="lightbox" aria-hidden="true">
        <div class="lightbox-content">
            <button type="button" class="lightbox-close" aria-label="Close">x</button>
            <img class="lightbox-img" alt="screenshot"/>
        </div>
    </div>

    <script>
        //<![CDATA[
        (function() {
            var lb = document.getElementById('lightbox');
            if (!lb) return;
            var img = lb.querySelector('.lightbox-img');
            var closeBtn = lb.querySelector('.lightbox-close');

            function openLightbox(src) {
                if (!src) return;
                img.src = src;
                lb.classList.add('is-open');
                lb.setAttribute('aria-hidden', 'false');
                document.body.classList.add('lb-open');
            }

            function closeLightbox() {
                lb.classList.remove('is-open');
                lb.setAttribute('aria-hidden', 'true');
                img.removeAttribute('src');
                document.body.classList.remove('lb-open');
            }

            document.addEventListener('click', function(e) {
                var link = e.target.closest('.js-lightbox');
                if (link) {
                    e.preventDefault();
                    openLightbox(link.getAttribute('href'));
                    return;
                }
                if (e.target === lb) {
                    closeLightbox();
                }
            });

            closeBtn.addEventListener('click', function() {
                closeLightbox();
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeLightbox();
            });
        })();

        (function() {
            var tree = document.getElementById('featTree');
            if (!tree) return;

            function syncFolderIcon(node) {
                if (!node) return;
                var row = node.querySelector('.treeRow[data-node-type="group"]');
                if (!row) return;
                row.classList.toggle('is-open', node.classList.contains('ui-treenode-expanded'));
            }

            function setExpanded(node, expanded) {
                if (!node) return;
                var children = node.querySelector('.ui-treenode-children');
                if (!children) return;
                node.classList.toggle('ui-treenode-expanded', expanded);
                node.classList.toggle('ui-treenode-collapsed', !expanded);
                children.style.display = expanded ? 'block' : 'none';
                syncFolderIcon(node);
            }

            function toggleNode(node, expand) {
                if (!node) return;
                var isExpanded = node.classList.contains('ui-treenode-expanded');
                var next = (expand === undefined) ? !isExpanded : expand;
                setExpanded(node, next);
            }

            document.addEventListener('click', function(e) {
                var toggle = e.target.closest('.js-tree-toggle');
                if (!toggle || !tree.contains(toggle)) return;
                e.preventDefault();
                e.stopPropagation();
                toggleNode(toggle.closest('li.ui-treenode'));
            });

            document.addEventListener('keydown', function(e) {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                var toggle = e.target.closest('.js-tree-toggle');
                if (!toggle || !tree.contains(toggle)) return;
                e.preventDefault();
                toggleNode(toggle.closest('li.ui-treenode'));
            });

            function statusMatches(filter, value) {
                if (filter === 'all') return true;
                if (!value) return false;
                var v = value.toUpperCase();
                if (filter === 'WARNING') {
                    return v === 'WARNING' || v === 'KNOWNBUG' || v === 'KNOWN_BUG' || v === 'KNOWN BUG';
                }
                return v === filter;
            }

            function applyFilters() {
                var activeStatuses = Array.prototype.slice.call(statusButtons)
                    .filter(function(btn) {
                        return btn.classList.contains('is-active') && btn.getAttribute('data-status') !== 'all';
                    })
                    .map(function(btn) { return btn.getAttribute('data-status'); });
                var statusAll = activeStatuses.length === 0;
                var tagSelect = document.getElementById('treeTagFilter');
                var tag = tagSelect ? tagSelect.value : '';

                var featureRows = tree.querySelectorAll('.treeRow[data-node-type="feature"]');
                featureRows.forEach(function(row) {
                    var node = row.closest('li.ui-treenode');
                    if (!node) return;
                    var nodeStatus = (row.getAttribute('data-status') || '').toUpperCase();
                    var tags = (row.getAttribute('data-tags') || '')
                        .split(/\s+/)
                        .filter(function(t) { return t.length; });

                    var statusOk = statusAll || activeStatuses.some(function(s) { return statusMatches(s, nodeStatus); });
                    var tagOk = !tag || tags.indexOf(tag) !== -1;
                    node.classList.toggle('hidden-by-filter', !(statusOk && tagOk));
                });

                var groupRows = tree.querySelectorAll('.treeRow[data-node-type="group"]');
                Array.from(groupRows).reverse().forEach(function(row) {
                    var node = row.closest('li.ui-treenode');
                    if (!node) return;
                    var hasVisible = node.querySelector('li.ui-treenode:not(.hidden-by-filter) .treeRow[data-node-type="feature"]');
                    node.classList.toggle('hidden-by-filter', !hasVisible);
                });
            }

            var statusButtons = document.querySelectorAll('.js-tree-status');
            var allBtn = document.querySelector('.js-tree-status[data-status="all"]');

            tree.querySelectorAll('li.ui-treenode').forEach(function(node) {
                syncFolderIcon(node);
            });

            statusButtons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var status = btn.getAttribute('data-status');
                    if (status === 'all') {
                        statusButtons.forEach(function(b) { b.classList.remove('is-active'); });
                        btn.classList.add('is-active');
                    } else {
                        btn.classList.toggle('is-active');
                        if (allBtn) allBtn.classList.remove('is-active');
                        var anyActive = Array.prototype.slice.call(statusButtons).some(function(b) {
                            return b.getAttribute('data-status') !== 'all' && b.classList.contains('is-active');
                        });
                        if (!anyActive && allBtn) {
                            allBtn.classList.add('is-active');
                        }
                    }
                    applyFilters();
                });
            });

            var tagSelect = document.getElementById('treeTagFilter');
            if (tagSelect) {
                tagSelect.addEventListener('change', applyFilters);
            }

            var expandBtn = document.getElementById('treeExpandAll');
            if (expandBtn) {
                expandBtn.addEventListener('click', function() {
                    tree.querySelectorAll('li.ui-treenode').forEach(function(node) {
                        setExpanded(node, true);
                    });
                });
            }

            var collapseBtn = document.getElementById('treeCollapseAll');
            if (collapseBtn) {
                collapseBtn.addEventListener('click', function() {
                    tree.querySelectorAll('li.ui-treenode').forEach(function(node) {
                        setExpanded(node, false);
                    });
                });
            }

            applyFilters();
        })();
        //]]>
    </script>
</h:body>
</html>
